'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _event = require('./event');

var _event2 = _interopRequireDefault(_event);

var _features_result = require('../models/features_result');

var _features_result2 = _interopRequireDefault(_features_result);

var _scenario_result = require('../models/scenario_result');

var _scenario_result2 = _interopRequireDefault(_scenario_result);

var _scenario_runner = require('./scenario_runner');

var _scenario_runner2 = _interopRequireDefault(_scenario_runner);

var _status = require('../status');

var _status2 = _interopRequireDefault(_status);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var FeaturesRunner = function () {
  function FeaturesRunner(_ref) {
    var eventBroadcaster = _ref.eventBroadcaster,
        features = _ref.features,
        options = _ref.options,
        supportCodeLibrary = _ref.supportCodeLibrary;
    (0, _classCallCheck3.default)(this, FeaturesRunner);

    this.eventBroadcaster = eventBroadcaster;
    this.features = features;
    this.options = options;
    this.supportCodeLibrary = supportCodeLibrary;
    this.featuresResult = new _features_result2.default(options.strict);
  }

  (0, _createClass3.default)(FeaturesRunner, [{
    key: 'run',
    value: function () {
      var _ref2 = (0, _bluebird.coroutine)(function* () {
        var _this = this;

        var event = new _event2.default({
          data: this.features,
          name: _event2.default.FEATURES_EVENT_NAME
        });
        yield this.eventBroadcaster.broadcastAroundEvent(event, (0, _bluebird.coroutine)(function* () {
          yield _bluebird2.default.each(_this.features, _this.runFeature.bind(_this));
          yield _this.broadcastFeaturesResult();
        }));
        return this.featuresResult.success;
      });

      function run() {
        return _ref2.apply(this, arguments);
      }

      return run;
    }()
  }, {
    key: 'broadcastFeaturesResult',
    value: function () {
      var _ref4 = (0, _bluebird.coroutine)(function* () {
        var event = new _event2.default({
          data: this.featuresResult,
          name: _event2.default.FEATURES_RESULT_EVENT_NAME
        });
        yield this.eventBroadcaster.broadcastEvent(event);
      });

      function broadcastFeaturesResult() {
        return _ref4.apply(this, arguments);
      }

      return broadcastFeaturesResult;
    }()
  }, {
    key: 'runFeature',
    value: function () {
      var _ref5 = (0, _bluebird.coroutine)(function* (feature) {
        var _this2 = this;

        var event = new _event2.default({ data: feature, name: _event2.default.FEATURE_EVENT_NAME });
        yield this.eventBroadcaster.broadcastAroundEvent(event, (0, _bluebird.coroutine)(function* () {
          yield _bluebird2.default.each(feature.scenarios, function () {
            var _ref7 = (0, _bluebird.coroutine)(function* (scenario) {
              var scenarioResult = yield _this2.runScenario(scenario);
              _this2.featuresResult.witnessScenarioResult(scenarioResult);
            });

            return function (_x2) {
              return _ref7.apply(this, arguments);
            };
          }());
        }));
      });

      function runFeature(_x) {
        return _ref5.apply(this, arguments);
      }

      return runFeature;
    }()
  }, {
    key: 'runScenario',
    value: function () {
      var _ref8 = (0, _bluebird.coroutine)(function* (scenario) {
        if (!this.featuresResult.success && this.options.failFast) {
          return new _scenario_result2.default(scenario, _status2.default.SKIPPED);
        }
        var scenarioRunner = new _scenario_runner2.default({
          eventBroadcaster: this.eventBroadcaster,
          options: this.options,
          scenario: scenario,
          supportCodeLibrary: this.supportCodeLibrary
        });
        return yield scenarioRunner.run();
      });

      function runScenario(_x3) {
        return _ref8.apply(this, arguments);
      }

      return runScenario;
    }()
  }]);
  return FeaturesRunner;
}();

exports.default = FeaturesRunner;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydW50aW1lL2ZlYXR1cmVzX3J1bm5lci5qcyJdLCJuYW1lcyI6WyJGZWF0dXJlc1J1bm5lciIsImV2ZW50QnJvYWRjYXN0ZXIiLCJmZWF0dXJlcyIsIm9wdGlvbnMiLCJzdXBwb3J0Q29kZUxpYnJhcnkiLCJmZWF0dXJlc1Jlc3VsdCIsInN0cmljdCIsImV2ZW50IiwiZGF0YSIsIm5hbWUiLCJGRUFUVVJFU19FVkVOVF9OQU1FIiwiYnJvYWRjYXN0QXJvdW5kRXZlbnQiLCJlYWNoIiwicnVuRmVhdHVyZSIsImJyb2FkY2FzdEZlYXR1cmVzUmVzdWx0Iiwic3VjY2VzcyIsIkZFQVRVUkVTX1JFU1VMVF9FVkVOVF9OQU1FIiwiYnJvYWRjYXN0RXZlbnQiLCJmZWF0dXJlIiwiRkVBVFVSRV9FVkVOVF9OQU1FIiwic2NlbmFyaW9zIiwic2NlbmFyaW8iLCJzY2VuYXJpb1Jlc3VsdCIsInJ1blNjZW5hcmlvIiwid2l0bmVzc1NjZW5hcmlvUmVzdWx0IiwiZmFpbEZhc3QiLCJTS0lQUEVEIiwic2NlbmFyaW9SdW5uZXIiLCJydW4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7Ozs7OztJQUVxQkEsYztBQUNuQixnQ0FBeUU7QUFBQSxRQUEzREMsZ0JBQTJELFFBQTNEQSxnQkFBMkQ7QUFBQSxRQUF6Q0MsUUFBeUMsUUFBekNBLFFBQXlDO0FBQUEsUUFBL0JDLE9BQStCLFFBQS9CQSxPQUErQjtBQUFBLFFBQXRCQyxrQkFBc0IsUUFBdEJBLGtCQUFzQjtBQUFBOztBQUN2RSxTQUFLSCxnQkFBTCxHQUF3QkEsZ0JBQXhCO0FBQ0EsU0FBS0MsUUFBTCxHQUFnQkEsUUFBaEI7QUFDQSxTQUFLQyxPQUFMLEdBQWVBLE9BQWY7QUFDQSxTQUFLQyxrQkFBTCxHQUEwQkEsa0JBQTFCO0FBQ0EsU0FBS0MsY0FBTCxHQUFzQiw4QkFBbUJGLFFBQVFHLE1BQTNCLENBQXRCO0FBQ0Q7Ozs7O3dEQUVXO0FBQUE7O0FBQ1YsWUFBTUMsUUFBUSxvQkFBVTtBQUN0QkMsZ0JBQU0sS0FBS04sUUFEVztBQUV0Qk8sZ0JBQU0sZ0JBQU1DO0FBRlUsU0FBVixDQUFkO0FBSUEsY0FBTSxLQUFLVCxnQkFBTCxDQUFzQlUsb0JBQXRCLENBQTJDSixLQUEzQywyQkFBa0QsYUFBWTtBQUNsRSxnQkFBTSxtQkFBUUssSUFBUixDQUFhLE1BQUtWLFFBQWxCLEVBQThCLE1BQUtXLFVBQW5DLGFBQU47QUFDQSxnQkFBTSxNQUFLQyx1QkFBTCxFQUFOO0FBQ0QsU0FISyxFQUFOO0FBSUEsZUFBTyxLQUFLVCxjQUFMLENBQW9CVSxPQUEzQjtBQUNELE87Ozs7Ozs7Ozs7O3dEQUUrQjtBQUM5QixZQUFNUixRQUFRLG9CQUFVO0FBQ3RCQyxnQkFBTSxLQUFLSCxjQURXO0FBRXRCSSxnQkFBTSxnQkFBTU87QUFGVSxTQUFWLENBQWQ7QUFJQSxjQUFNLEtBQUtmLGdCQUFMLENBQXNCZ0IsY0FBdEIsQ0FBcUNWLEtBQXJDLENBQU47QUFDRCxPOzs7Ozs7Ozs7OztzREFFZ0JXLE8sRUFBUztBQUFBOztBQUN4QixZQUFNWCxRQUFRLG9CQUFVLEVBQUVDLE1BQU1VLE9BQVIsRUFBaUJULE1BQU0sZ0JBQU1VLGtCQUE3QixFQUFWLENBQWQ7QUFDQSxjQUFNLEtBQUtsQixnQkFBTCxDQUFzQlUsb0JBQXRCLENBQTJDSixLQUEzQywyQkFBa0QsYUFBWTtBQUNsRSxnQkFBTSxtQkFBUUssSUFBUixDQUFhTSxRQUFRRSxTQUFyQjtBQUFBLGlEQUFnQyxXQUFNQyxRQUFOLEVBQWtCO0FBQ3RELGtCQUFNQyxpQkFBaUIsTUFBTSxPQUFLQyxXQUFMLENBQWlCRixRQUFqQixDQUE3QjtBQUNBLHFCQUFLaEIsY0FBTCxDQUFvQm1CLHFCQUFwQixDQUEwQ0YsY0FBMUM7QUFDRCxhQUhLOztBQUFBO0FBQUE7QUFBQTtBQUFBLGNBQU47QUFJRCxTQUxLLEVBQU47QUFNRCxPOzs7Ozs7Ozs7OztzREFFaUJELFEsRUFBVTtBQUMxQixZQUFJLENBQUMsS0FBS2hCLGNBQUwsQ0FBb0JVLE9BQXJCLElBQWdDLEtBQUtaLE9BQUwsQ0FBYXNCLFFBQWpELEVBQTJEO0FBQ3pELGlCQUFPLDhCQUFtQkosUUFBbkIsRUFBNkIsaUJBQU9LLE9BQXBDLENBQVA7QUFDRDtBQUNELFlBQU1DLGlCQUFpQiw4QkFBbUI7QUFDeEMxQiw0QkFBa0IsS0FBS0EsZ0JBRGlCO0FBRXhDRSxtQkFBUyxLQUFLQSxPQUYwQjtBQUd4Q2tCLDRCQUh3QztBQUl4Q2pCLDhCQUFvQixLQUFLQTtBQUplLFNBQW5CLENBQXZCO0FBTUEsZUFBTyxNQUFNdUIsZUFBZUMsR0FBZixFQUFiO0FBQ0QsTzs7Ozs7Ozs7Ozs7O2tCQWxEa0I1QixjIiwiZmlsZSI6ImZlYXR1cmVzX3J1bm5lci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBFdmVudCBmcm9tICcuL2V2ZW50J1xuaW1wb3J0IEZlYXR1cmVzUmVzdWx0IGZyb20gJy4uL21vZGVscy9mZWF0dXJlc19yZXN1bHQnXG5pbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcbmltcG9ydCBTY2VuYXJpb1Jlc3VsdCBmcm9tICcuLi9tb2RlbHMvc2NlbmFyaW9fcmVzdWx0J1xuaW1wb3J0IFNjZW5hcmlvUnVubmVyIGZyb20gJy4vc2NlbmFyaW9fcnVubmVyJ1xuaW1wb3J0IFN0YXR1cyBmcm9tICcuLi9zdGF0dXMnXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEZlYXR1cmVzUnVubmVyIHtcbiAgY29uc3RydWN0b3IoeyBldmVudEJyb2FkY2FzdGVyLCBmZWF0dXJlcywgb3B0aW9ucywgc3VwcG9ydENvZGVMaWJyYXJ5IH0pIHtcbiAgICB0aGlzLmV2ZW50QnJvYWRjYXN0ZXIgPSBldmVudEJyb2FkY2FzdGVyXG4gICAgdGhpcy5mZWF0dXJlcyA9IGZlYXR1cmVzXG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9uc1xuICAgIHRoaXMuc3VwcG9ydENvZGVMaWJyYXJ5ID0gc3VwcG9ydENvZGVMaWJyYXJ5XG4gICAgdGhpcy5mZWF0dXJlc1Jlc3VsdCA9IG5ldyBGZWF0dXJlc1Jlc3VsdChvcHRpb25zLnN0cmljdClcbiAgfVxuXG4gIGFzeW5jIHJ1bigpIHtcbiAgICBjb25zdCBldmVudCA9IG5ldyBFdmVudCh7XG4gICAgICBkYXRhOiB0aGlzLmZlYXR1cmVzLFxuICAgICAgbmFtZTogRXZlbnQuRkVBVFVSRVNfRVZFTlRfTkFNRVxuICAgIH0pXG4gICAgYXdhaXQgdGhpcy5ldmVudEJyb2FkY2FzdGVyLmJyb2FkY2FzdEFyb3VuZEV2ZW50KGV2ZW50LCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBQcm9taXNlLmVhY2godGhpcy5mZWF0dXJlcywgOjp0aGlzLnJ1bkZlYXR1cmUpXG4gICAgICBhd2FpdCB0aGlzLmJyb2FkY2FzdEZlYXR1cmVzUmVzdWx0KClcbiAgICB9KVxuICAgIHJldHVybiB0aGlzLmZlYXR1cmVzUmVzdWx0LnN1Y2Nlc3NcbiAgfVxuXG4gIGFzeW5jIGJyb2FkY2FzdEZlYXR1cmVzUmVzdWx0KCkge1xuICAgIGNvbnN0IGV2ZW50ID0gbmV3IEV2ZW50KHtcbiAgICAgIGRhdGE6IHRoaXMuZmVhdHVyZXNSZXN1bHQsXG4gICAgICBuYW1lOiBFdmVudC5GRUFUVVJFU19SRVNVTFRfRVZFTlRfTkFNRVxuICAgIH0pXG4gICAgYXdhaXQgdGhpcy5ldmVudEJyb2FkY2FzdGVyLmJyb2FkY2FzdEV2ZW50KGV2ZW50KVxuICB9XG5cbiAgYXN5bmMgcnVuRmVhdHVyZShmZWF0dXJlKSB7XG4gICAgY29uc3QgZXZlbnQgPSBuZXcgRXZlbnQoeyBkYXRhOiBmZWF0dXJlLCBuYW1lOiBFdmVudC5GRUFUVVJFX0VWRU5UX05BTUUgfSlcbiAgICBhd2FpdCB0aGlzLmV2ZW50QnJvYWRjYXN0ZXIuYnJvYWRjYXN0QXJvdW5kRXZlbnQoZXZlbnQsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IFByb21pc2UuZWFjaChmZWF0dXJlLnNjZW5hcmlvcywgYXN5bmMgc2NlbmFyaW8gPT4ge1xuICAgICAgICBjb25zdCBzY2VuYXJpb1Jlc3VsdCA9IGF3YWl0IHRoaXMucnVuU2NlbmFyaW8oc2NlbmFyaW8pXG4gICAgICAgIHRoaXMuZmVhdHVyZXNSZXN1bHQud2l0bmVzc1NjZW5hcmlvUmVzdWx0KHNjZW5hcmlvUmVzdWx0KVxuICAgICAgfSlcbiAgICB9KVxuICB9XG5cbiAgYXN5bmMgcnVuU2NlbmFyaW8oc2NlbmFyaW8pIHtcbiAgICBpZiAoIXRoaXMuZmVhdHVyZXNSZXN1bHQuc3VjY2VzcyAmJiB0aGlzLm9wdGlvbnMuZmFpbEZhc3QpIHtcbiAgICAgIHJldHVybiBuZXcgU2NlbmFyaW9SZXN1bHQoc2NlbmFyaW8sIFN0YXR1cy5TS0lQUEVEKVxuICAgIH1cbiAgICBjb25zdCBzY2VuYXJpb1J1bm5lciA9IG5ldyBTY2VuYXJpb1J1bm5lcih7XG4gICAgICBldmVudEJyb2FkY2FzdGVyOiB0aGlzLmV2ZW50QnJvYWRjYXN0ZXIsXG4gICAgICBvcHRpb25zOiB0aGlzLm9wdGlvbnMsXG4gICAgICBzY2VuYXJpbyxcbiAgICAgIHN1cHBvcnRDb2RlTGlicmFyeTogdGhpcy5zdXBwb3J0Q29kZUxpYnJhcnlcbiAgICB9KVxuICAgIHJldHVybiBhd2FpdCBzY2VuYXJpb1J1bm5lci5ydW4oKVxuICB9XG59XG4iXX0=