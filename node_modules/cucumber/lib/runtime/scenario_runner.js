'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require('babel-runtime/helpers/createClass');

var _createClass3 = _interopRequireDefault(_createClass2);

var _attachment_manager = require('./attachment_manager');

var _attachment_manager2 = _interopRequireDefault(_attachment_manager);

var _event = require('./event');

var _event2 = _interopRequireDefault(_event);

var _hook = require('../models/hook');

var _hook2 = _interopRequireDefault(_hook);

var _scenario_result = require('../models/scenario_result');

var _scenario_result2 = _interopRequireDefault(_scenario_result);

var _status = require('../status');

var _status2 = _interopRequireDefault(_status);

var _step_result = require('../models/step_result');

var _step_result2 = _interopRequireDefault(_step_result);

var _step_runner = require('./step_runner');

var _step_runner2 = _interopRequireDefault(_step_runner);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var ScenarioRunner = function () {
  function ScenarioRunner(_ref) {
    var _context;

    var eventBroadcaster = _ref.eventBroadcaster,
        options = _ref.options,
        scenario = _ref.scenario,
        supportCodeLibrary = _ref.supportCodeLibrary;
    (0, _classCallCheck3.default)(this, ScenarioRunner);

    this.attachmentManager = new _attachment_manager2.default();
    this.eventBroadcaster = eventBroadcaster;
    this.options = options;
    this.scenario = scenario;
    this.supportCodeLibrary = supportCodeLibrary;
    this.scenarioResult = new _scenario_result2.default(scenario);
    this.world = new supportCodeLibrary.World({
      attach: (_context = this.attachmentManager).create.bind(_context),
      parameters: options.worldParameters
    });
  }

  (0, _createClass3.default)(ScenarioRunner, [{
    key: 'broadcastScenarioResult',
    value: function () {
      var _ref2 = (0, _bluebird.coroutine)(function* () {
        var event = new _event2.default({
          data: this.scenarioResult,
          name: _event2.default.SCENARIO_RESULT_EVENT_NAME
        });
        yield this.eventBroadcaster.broadcastEvent(event);
      });

      function broadcastScenarioResult() {
        return _ref2.apply(this, arguments);
      }

      return broadcastScenarioResult;
    }()
  }, {
    key: 'broadcastStepResult',
    value: function () {
      var _ref3 = (0, _bluebird.coroutine)(function* (stepResult) {
        this.scenarioResult.witnessStepResult(stepResult);
        var event = new _event2.default({
          data: stepResult,
          name: _event2.default.STEP_RESULT_EVENT_NAME
        });
        yield this.eventBroadcaster.broadcastEvent(event);
      });

      function broadcastStepResult(_x) {
        return _ref3.apply(this, arguments);
      }

      return broadcastStepResult;
    }()
  }, {
    key: 'invokeStep',
    value: function invokeStep(step, stepDefinition) {
      return _step_runner2.default.run({
        attachmentManager: this.attachmentManager,
        defaultTimeout: this.supportCodeLibrary.defaultTimeout,
        scenarioResult: this.scenarioResult,
        step: step,
        stepDefinition: stepDefinition,
        parameterTypeRegistry: this.supportCodeLibrary.parameterTypeRegistry,
        world: this.world
      });
    }
  }, {
    key: 'isSkippingSteps',
    value: function isSkippingSteps() {
      return this.scenarioResult.status !== _status2.default.PASSED;
    }
  }, {
    key: 'run',
    value: function () {
      var _ref4 = (0, _bluebird.coroutine)(function* () {
        var _this = this;

        var event = new _event2.default({
          data: this.scenario,
          name: _event2.default.SCENARIO_EVENT_NAME
        });
        yield this.eventBroadcaster.broadcastAroundEvent(event, (0, _bluebird.coroutine)(function* () {
          yield _this.runBeforeHooks();
          yield _this.runSteps();
          yield _this.runAfterHooks();
          yield _this.broadcastScenarioResult();
        }));
        return this.scenarioResult;
      });

      function run() {
        return _ref4.apply(this, arguments);
      }

      return run;
    }()
  }, {
    key: 'runAfterHooks',
    value: function () {
      var _ref6 = (0, _bluebird.coroutine)(function* () {
        yield this.runHooks({
          hookDefinitions: this.supportCodeLibrary.afterHookDefinitions,
          hookKeyword: _hook2.default.AFTER_STEP_KEYWORD
        });
      });

      function runAfterHooks() {
        return _ref6.apply(this, arguments);
      }

      return runAfterHooks;
    }()
  }, {
    key: 'runBeforeHooks',
    value: function () {
      var _ref7 = (0, _bluebird.coroutine)(function* () {
        yield this.runHooks({
          hookDefinitions: this.supportCodeLibrary.beforeHookDefinitions,
          hookKeyword: _hook2.default.BEFORE_STEP_KEYWORD
        });
      });

      function runBeforeHooks() {
        return _ref7.apply(this, arguments);
      }

      return runBeforeHooks;
    }()
  }, {
    key: 'runHook',
    value: function () {
      var _ref8 = (0, _bluebird.coroutine)(function* (hook, hookDefinition) {
        if (this.options.dryRun) {
          return new _step_result2.default({
            step: hook,
            stepDefinition: hookDefinition,
            status: _status2.default.SKIPPED
          });
        } else {
          return yield this.invokeStep(hook, hookDefinition);
        }
      });

      function runHook(_x2, _x3) {
        return _ref8.apply(this, arguments);
      }

      return runHook;
    }()
  }, {
    key: 'runHooks',
    value: function () {
      var _ref10 = (0, _bluebird.coroutine)(function* (_ref9) {
        var _this2 = this;

        var hookDefinitions = _ref9.hookDefinitions,
            hookKeyword = _ref9.hookKeyword;

        yield _bluebird2.default.each(hookDefinitions, function () {
          var _ref11 = (0, _bluebird.coroutine)(function* (hookDefinition) {
            if (!hookDefinition.appliesToScenario(_this2.scenario)) {
              return;
            }
            var hook = new _hook2.default({ keyword: hookKeyword, scenario: _this2.scenario });
            var event = new _event2.default({ data: hook, name: _event2.default.STEP_EVENT_NAME });
            yield _this2.eventBroadcaster.broadcastAroundEvent(event, (0, _bluebird.coroutine)(function* () {
              var stepResult = yield _this2.runHook(hook, hookDefinition);
              yield _this2.broadcastStepResult(stepResult);
            }));
          });

          return function (_x5) {
            return _ref11.apply(this, arguments);
          };
        }());
      });

      function runHooks(_x4) {
        return _ref10.apply(this, arguments);
      }

      return runHooks;
    }()
  }, {
    key: 'runStep',
    value: function () {
      var _ref13 = (0, _bluebird.coroutine)(function* (step) {
        var _this3 = this;

        var stepDefinitions = this.supportCodeLibrary.stepDefinitions.filter(function (stepDefinition) {
          return stepDefinition.matchesStepName({
            stepName: step.name,
            parameterTypeRegistry: _this3.supportCodeLibrary.parameterTypeRegistry
          });
        });
        if (stepDefinitions.length === 0) {
          return new _step_result2.default({
            step: step,
            status: _status2.default.UNDEFINED
          });
        } else if (stepDefinitions.length > 1) {
          return new _step_result2.default({
            ambiguousStepDefinitions: stepDefinitions,
            step: step,
            status: _status2.default.AMBIGUOUS
          });
        } else if (this.options.dryRun || this.isSkippingSteps()) {
          return new _step_result2.default({
            step: step,
            stepDefinition: stepDefinitions[0],
            status: _status2.default.SKIPPED
          });
        } else {
          return yield this.invokeStep(step, stepDefinitions[0]);
        }
      });

      function runStep(_x6) {
        return _ref13.apply(this, arguments);
      }

      return runStep;
    }()
  }, {
    key: 'runSteps',
    value: function () {
      var _ref14 = (0, _bluebird.coroutine)(function* () {
        var _this4 = this;

        yield _bluebird2.default.each(this.scenario.steps, function () {
          var _ref15 = (0, _bluebird.coroutine)(function* (step) {
            var event = new _event2.default({ data: step, name: _event2.default.STEP_EVENT_NAME });
            yield _this4.eventBroadcaster.broadcastAroundEvent(event, (0, _bluebird.coroutine)(function* () {
              var stepResult = yield _this4.runStep(step);
              yield _this4.broadcastStepResult(stepResult);
            }));
          });

          return function (_x7) {
            return _ref15.apply(this, arguments);
          };
        }());
      });

      function runSteps() {
        return _ref14.apply(this, arguments);
      }

      return runSteps;
    }()
  }]);
  return ScenarioRunner;
}();

exports.default = ScenarioRunner;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydW50aW1lL3NjZW5hcmlvX3J1bm5lci5qcyJdLCJuYW1lcyI6WyJTY2VuYXJpb1J1bm5lciIsImV2ZW50QnJvYWRjYXN0ZXIiLCJvcHRpb25zIiwic2NlbmFyaW8iLCJzdXBwb3J0Q29kZUxpYnJhcnkiLCJhdHRhY2htZW50TWFuYWdlciIsInNjZW5hcmlvUmVzdWx0Iiwid29ybGQiLCJXb3JsZCIsImF0dGFjaCIsImNyZWF0ZSIsInBhcmFtZXRlcnMiLCJ3b3JsZFBhcmFtZXRlcnMiLCJldmVudCIsImRhdGEiLCJuYW1lIiwiU0NFTkFSSU9fUkVTVUxUX0VWRU5UX05BTUUiLCJicm9hZGNhc3RFdmVudCIsInN0ZXBSZXN1bHQiLCJ3aXRuZXNzU3RlcFJlc3VsdCIsIlNURVBfUkVTVUxUX0VWRU5UX05BTUUiLCJzdGVwIiwic3RlcERlZmluaXRpb24iLCJydW4iLCJkZWZhdWx0VGltZW91dCIsInBhcmFtZXRlclR5cGVSZWdpc3RyeSIsInN0YXR1cyIsIlBBU1NFRCIsIlNDRU5BUklPX0VWRU5UX05BTUUiLCJicm9hZGNhc3RBcm91bmRFdmVudCIsInJ1bkJlZm9yZUhvb2tzIiwicnVuU3RlcHMiLCJydW5BZnRlckhvb2tzIiwiYnJvYWRjYXN0U2NlbmFyaW9SZXN1bHQiLCJydW5Ib29rcyIsImhvb2tEZWZpbml0aW9ucyIsImFmdGVySG9va0RlZmluaXRpb25zIiwiaG9va0tleXdvcmQiLCJBRlRFUl9TVEVQX0tFWVdPUkQiLCJiZWZvcmVIb29rRGVmaW5pdGlvbnMiLCJCRUZPUkVfU1RFUF9LRVlXT1JEIiwiaG9vayIsImhvb2tEZWZpbml0aW9uIiwiZHJ5UnVuIiwiU0tJUFBFRCIsImludm9rZVN0ZXAiLCJlYWNoIiwiYXBwbGllc1RvU2NlbmFyaW8iLCJrZXl3b3JkIiwiU1RFUF9FVkVOVF9OQU1FIiwicnVuSG9vayIsImJyb2FkY2FzdFN0ZXBSZXN1bHQiLCJzdGVwRGVmaW5pdGlvbnMiLCJmaWx0ZXIiLCJtYXRjaGVzU3RlcE5hbWUiLCJzdGVwTmFtZSIsImxlbmd0aCIsIlVOREVGSU5FRCIsImFtYmlndW91c1N0ZXBEZWZpbml0aW9ucyIsIkFNQklHVU9VUyIsImlzU2tpcHBpbmdTdGVwcyIsInN0ZXBzIiwicnVuU3RlcCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7OztJQUVxQkEsYztBQUNuQixnQ0FBeUU7QUFBQTs7QUFBQSxRQUEzREMsZ0JBQTJELFFBQTNEQSxnQkFBMkQ7QUFBQSxRQUF6Q0MsT0FBeUMsUUFBekNBLE9BQXlDO0FBQUEsUUFBaENDLFFBQWdDLFFBQWhDQSxRQUFnQztBQUFBLFFBQXRCQyxrQkFBc0IsUUFBdEJBLGtCQUFzQjtBQUFBOztBQUN2RSxTQUFLQyxpQkFBTCxHQUF5QixrQ0FBekI7QUFDQSxTQUFLSixnQkFBTCxHQUF3QkEsZ0JBQXhCO0FBQ0EsU0FBS0MsT0FBTCxHQUFlQSxPQUFmO0FBQ0EsU0FBS0MsUUFBTCxHQUFnQkEsUUFBaEI7QUFDQSxTQUFLQyxrQkFBTCxHQUEwQkEsa0JBQTFCO0FBQ0EsU0FBS0UsY0FBTCxHQUFzQiw4QkFBbUJILFFBQW5CLENBQXRCO0FBQ0EsU0FBS0ksS0FBTCxHQUFhLElBQUlILG1CQUFtQkksS0FBdkIsQ0FBNkI7QUFDeENDLGNBQVUsaUJBQUtKLGlCQUFMLEVBQXVCSyxNQUFqQyxlQUR3QztBQUV4Q0Msa0JBQVlULFFBQVFVO0FBRm9CLEtBQTdCLENBQWI7QUFJRDs7Ozs7d0RBRStCO0FBQzlCLFlBQU1DLFFBQVEsb0JBQVU7QUFDdEJDLGdCQUFNLEtBQUtSLGNBRFc7QUFFdEJTLGdCQUFNLGdCQUFNQztBQUZVLFNBQVYsQ0FBZDtBQUlBLGNBQU0sS0FBS2YsZ0JBQUwsQ0FBc0JnQixjQUF0QixDQUFxQ0osS0FBckMsQ0FBTjtBQUNELE87Ozs7Ozs7Ozs7O3NEQUV5QkssVSxFQUFZO0FBQ3BDLGFBQUtaLGNBQUwsQ0FBb0JhLGlCQUFwQixDQUFz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QUFNLG1CQUFRTixJQUFSLENBQWEsS0FBSzNDLFFBQUwsQ0FBYzBELEtBQTNCO0FBQUEsZ0RBQWtDLFdBQU14QyxJQUFOLEVBQWM7QUFDcEQsZ0JBQU1SLFFBQVEsb0JBQVUsRUFBRUMsTUFBTU8sSUFBUixFQUFjTixNQUFNLGdCQUFNa0MsZUFBMUIsRUFBVixDQUFkO0FBQ0Esa0JBQU0sT0FBS2hELGdCQUFMLENBQXNCNEIsb0JBQXRCLENBQTJDaEIsS0FBM0MsMkJBQWtELGFBQVk7QUFDbEUsa0JBQU1LLGFBQWEsTUFBTSxPQUFLNEMsT0FBTCxDQUFhekMsSUFBYixDQUF6QjtBQUNBLG9CQUFNLE9BQUs4QixtQkFBTCxDQUF5QmpDLFVBQXpCLENBQU47QUFDRCxhQUhLLEVBQU47QUFJRCxXQU5LOztBQUFBO0FBQUE7QUFBQTtBQUFBLFlBQU47QUFPRCxPOzs7Ozs7Ozs7Ozs7a0JBNUlrQmxCLGMiLCJmaWxlIjoic2NlbmFyaW9fcnVubmVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEF0dGFjaG1lbnRNYW5hZ2VyIGZyb20gJy4vYXR0YWNobWVudF9tYW5hZ2VyJ1xuaW1wb3J0IEV2ZW50IGZyb20gJy4vZXZlbnQnXG5pbXBvcnQgSG9vayBmcm9tICcuLi9tb2RlbHMvaG9vaydcbmltcG9ydCBQcm9taXNlIGZyb20gJ2JsdWViaXJkJ1xuaW1wb3J0IFNjZW5hcmlvUmVzdWx0IGZyb20gJy4uL21vZGVscy9zY2VuYXJpb19yZXN1bHQnXG5pbXBvcnQgU3RhdHVzIGZyb20gJy4uL3N0YXR1cydcbmltcG9ydCBTdGVwUmVzdWx0IGZyb20gJy4uL21vZGVscy9zdGVwX3Jlc3VsdCdcbmltcG9ydCBTdGVwUnVubmVyIGZyb20gJy4vc3RlcF9ydW5uZXInXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNjZW5hcmlvUnVubmVyIHtcbiAgY29uc3RydWN0b3IoeyBldmVudEJyb2FkY2FzdGVyLCBvcHRpb25zLCBzY2VuYXJpbywgc3VwcG9ydENvZGVMaWJyYXJ5IH0pIHtcbiAgICB0aGlzLmF0dGFjaG1lbnRNYW5hZ2VyID0gbmV3IEF0dGFjaG1lbnRNYW5hZ2VyKClcbiAgICB0aGlzLmV2ZW50QnJvYWRjYXN0ZXIgPSBldmVudEJyb2FkY2FzdGVyXG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9uc1xuICAgIHRoaXMuc2NlbmFyaW8gPSBzY2VuYXJpb1xuICAgIHRoaXMuc3VwcG9ydENvZGVMaWJyYXJ5ID0gc3VwcG9ydENvZGVMaWJyYXJ5XG4gICAgdGhpcy5zY2VuYXJpb1Jlc3VsdCA9IG5ldyBTY2VuYXJpb1Jlc3VsdChzY2VuYXJpbylcbiAgICB0aGlzLndvcmxkID0gbmV3IHN1cHBvcnRDb2RlTGlicmFyeS5Xb3JsZCh7XG4gICAgICBhdHRhY2g6IDo6dGhpcy5hdHRhY2htZW50TWFuYWdlci5jcmVhdGUsXG4gICAgICBwYXJhbWV0ZXJzOiBvcHRpb25zLndvcmxkUGFyYW1ldGVyc1xuICAgIH0pXG4gIH1cblxuICBhc3luYyBicm9hZGNhc3RTY2VuYXJpb1Jlc3VsdCgpIHtcbiAgICBjb25zdCBldmVudCA9IG5ldyBFdmVudCh7XG4gICAgICBkYXRhOiB0aGlzLnNjZW5hcmlvUmVzdWx0LFxuICAgICAgbmFtZTogRXZlbnQuU0NFTkFSSU9fUkVTVUxUX0VWRU5UX05BTUVcbiAgICB9KVxuICAgIGF3YWl0IHRoaXMuZXZlbnRCcm9hZGNhc3Rlci5icm9hZGNhc3RFdmVudChldmVudClcbiAgfVxuXG4gIGFzeW5jIGJyb2FkY2FzdFN0ZXBSZXN1bHQoc3RlcFJlc3VsdCkge1xuICAgIHRoaXMuc2NlbmFyaW9SZXN1bHQud2l0bmVzc1N0ZXBSZXN1bHQoc3RlcFJlc3VsdClcbiAgICBjb25zdCBldmVudCA9IG5ldyBFdmVudCh7XG4gICAgICBkYXRhOiBzdGVwUmVzdWx0LFxuICAgICAgbmFtZTogRXZlbnQuU1RFUF9SRVNVTFRfRVZFTlRfTkFNRVxuICAgIH0pXG4gICAgYXdhaXQgdGhpcy5ldmVudEJyb2FkY2FzdGVyLmJyb2FkY2FzdEV2ZW50KGV2ZW50KVxuICB9XG5cbiAgaW52b2tlU3RlcChzdGVwLCBzdGVwRGVmaW5pdGlvbikge1xuICAgIHJldHVybiBTdGVwUnVubmVyLnJ1bih7XG4gICAgICBhdHRhY2htZW50TWFuYWdlcjogdGhpcy5hdHRhY2htZW50TWFuYWdlcixcbiAgICAgIGRlZmF1bHRUaW1lb3V0OiB0aGlzLnN1cHBvcnRDb2RlTGlicmFyeS5kZWZhdWx0VGltZW91dCxcbiAgICAgIHNjZW5hcmlvUmVzdWx0OiB0aGlzLnNjZW5hcmlvUmVzdWx0LFxuICAgICAgc3RlcCxcbiAgICAgIHN0ZXBEZWZpbml0aW9uLFxuICAgICAgcGFyYW1ldGVyVHlwZVJlZ2lzdHJ5OiB0aGlzLnN1cHBvcnRDb2RlTGlicmFyeS5wYXJhbWV0ZXJUeXBlUmVnaXN0cnksXG4gICAgICB3b3JsZDogdGhpcy53b3JsZFxuICAgIH0pXG4gIH1cblxuICBpc1NraXBwaW5nU3RlcHMoKSB7XG4gICAgcmV0dXJuIHRoaXMuc2NlbmFyaW9SZXN1bHQuc3RhdHVzICE9PSBTdGF0dXMuUEFTU0VEXG4gIH1cblxuICBhc3luYyBydW4oKSB7XG4gICAgY29uc3QgZXZlbnQgPSBuZXcgRXZlbnQoe1xuICAgICAgZGF0YTogdGhpcy5zY2VuYXJpbyxcbiAgICAgIG5hbWU6IEV2ZW50LlNDRU5BUklPX0VWRU5UX05BTUVcbiAgICB9KVxuICAgIGF3YWl0IHRoaXMuZXZlbnRCcm9hZGNhc3Rlci5icm9hZGNhc3RBcm91bmRFdmVudChldmVudCwgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgdGhpcy5ydW5CZWZvcmVIb29rcygpXG4gICAgICBhd2FpdCB0aGlzLnJ1blN0ZXBzKClcbiAgICAgIGF3YWl0IHRoaXMucnVuQWZ0ZXJIb29rcygpXG4gICAgICBhd2FpdCB0aGlzLmJyb2FkY2FzdFNjZW5hcmlvUmVzdWx0KClcbiAgICB9KVxuICAgIHJldHVybiB0aGlzLnNjZW5hcmlvUmVzdWx0XG4gIH1cblxuICBhc3luYyBydW5BZnRlckhvb2tzKCkge1xuICAgIGF3YWl0IHRoaXMucnVuSG9va3Moe1xuICAgICAgaG9va0RlZmluaXRpb25zOiB0aGlzLnN1cHBvcnRDb2RlTGlicmFyeS5hZnRlckhvb2tEZWZpbml0aW9ucyxcbiAgICAgIGhvb2tLZXl3b3JkOiBIb29rLkFGVEVSX1NURVBfS0VZV09SRFxuICAgIH0pXG4gIH1cblxuICBhc3luYyBydW5CZWZvcmVIb29rcygpIHtcbiAgICBhd2FpdCB0aGlzLnJ1bkhvb2tzKHtcbiAgICAgIGhvb2tEZWZpbml0aW9uczogdGhpcy5zdXBwb3J0Q29kZUxpYnJhcnkuYmVmb3JlSG9va0RlZmluaXRpb25zLFxuICAgICAgaG9va0tleXdvcmQ6IEhvb2suQkVGT1JFX1NURVBfS0VZV09SRFxuICAgIH0pXG4gIH1cblxuICBhc3luYyBydW5Ib29rKGhvb2ssIGhvb2tEZWZpbml0aW9uKSB7XG4gICAgaWYgKHRoaXMub3B0aW9ucy5kcnlSdW4pIHtcbiAgICAgIHJldHVybiBuZXcgU3RlcFJlc3VsdCh7XG4gICAgICAgIHN0ZXA6IGhvb2ssXG4gICAgICAgIHN0ZXBEZWZpbml0aW9uOiBob29rRGVmaW5pdGlvbixcbiAgICAgICAgc3RhdHVzOiBTdGF0dXMuU0tJUFBFRFxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuaW52b2tlU3RlcChob29rLCBob29rRGVmaW5pdGlvbilcbiAgICB9XG4gIH1cblxuICBhc3luYyBydW5Ib29rcyh7IGhvb2tEZWZpbml0aW9ucywgaG9va0tleXdvcmQgfSkge1xuICAgIGF3YWl0IFByb21pc2UuZWFjaChob29rRGVmaW5pdGlvbnMsIGFzeW5jIGhvb2tEZWZpbml0aW9uID0+IHtcbiAgICAgIGlmICghaG9va0RlZmluaXRpb24uYXBwbGllc1RvU2NlbmFyaW8odGhpcy5zY2VuYXJpbykpIHtcbiAgICAgICAgcmV0dXJuXG4gICAgICB9XG4gICAgICBjb25zdCBob29rID0gbmV3IEhvb2soeyBrZXl3b3JkOiBob29rS2V5d29yZCwgc2NlbmFyaW86IHRoaXMuc2NlbmFyaW8gfSlcbiAgICAgIGNvbnN0IGV2ZW50ID0gbmV3IEV2ZW50KHsgZGF0YTogaG9vaywgbmFtZTogRXZlbnQuU1RFUF9FVkVOVF9OQU1FIH0pXG4gICAgICBhd2FpdCB0aGlzLmV2ZW50QnJvYWRjYXN0ZXIuYnJvYWRjYXN0QXJvdW5kRXZlbnQoZXZlbnQsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3Qgc3RlcFJlc3VsdCA9IGF3YWl0IHRoaXMucnVuSG9vayhob29rLCBob29rRGVmaW5pdGlvbilcbiAgICAgICAgYXdhaXQgdGhpcy5icm9hZGNhc3RTdGVwUmVzdWx0KHN0ZXBSZXN1bHQpXG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICBhc3luYyBydW5TdGVwKHN0ZXApIHtcbiAgICBjb25zdCBzdGVwRGVmaW5pdGlvbnMgPSB0aGlzLnN1cHBvcnRDb2RlTGlicmFyeS5zdGVwRGVmaW5pdGlvbnMuZmlsdGVyKFxuICAgICAgc3RlcERlZmluaXRpb24gPT4ge1xuICAgICAgICByZXR1cm4gc3RlcERlZmluaXRpb24ubWF0Y2hlc1N0ZXBOYW1lKHtcbiAgICAgICAgICBzdGVwTmFtZTogc3RlcC5uYW1lLFxuICAgICAgICAgIHBhcmFtZXRlclR5cGVSZWdpc3RyeTogdGhpcy5zdXBwb3J0Q29kZUxpYnJhcnkucGFyYW1ldGVyVHlwZVJlZ2lzdHJ5XG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgKVxuICAgIGlmIChzdGVwRGVmaW5pdGlvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gbmV3IFN0ZXBSZXN1bHQoe1xuICAgICAgICBzdGVwLFxuICAgICAgICBzdGF0dXM6IFN0YXR1cy5VTkRFRklORURcbiAgICAgIH0pXG4gICAgfSBlbHNlIGlmIChzdGVwRGVmaW5pdGlvbnMubGVuZ3RoID4gMSkge1xuICAgICAgcmV0dXJuIG5ldyBTdGVwUmVzdWx0KHtcbiAgICAgICAgYW1iaWd1b3VzU3RlcERlZmluaXRpb25zOiBzdGVwRGVmaW5pdGlvbnMsXG4gICAgICAgIHN0ZXAsXG4gICAgICAgIHN0YXR1czogU3RhdHVzLkFNQklHVU9VU1xuICAgICAgfSlcbiAgICB9IGVsc2UgaWYgKHRoaXMub3B0aW9ucy5kcnlSdW4gfHwgdGhpcy5pc1NraXBwaW5nU3RlcHMoKSkge1xuICAgICAgcmV0dXJuIG5ldyBTdGVwUmVzdWx0KHtcbiAgICAgICAgc3RlcCxcbiAgICAgICAgc3RlcERlZmluaXRpb246IHN0ZXBEZWZpbml0aW9uc1swXSxcbiAgICAgICAgc3RhdHVzOiBTdGF0dXMuU0tJUFBFRFxuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuaW52b2tlU3RlcChzdGVwLCBzdGVwRGVmaW5pdGlvbnNbMF0pXG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcnVuU3RlcHMoKSB7XG4gICAgYXdhaXQgUHJvbWlzZS5lYWNoKHRoaXMuc2NlbmFyaW8uc3RlcHMsIGFzeW5jIHN0ZXAgPT4ge1xuICAgICAgY29uc3QgZXZlbnQgPSBuZXcgRXZlbnQoeyBkYXRhOiBzdGVwLCBuYW1lOiBFdmVudC5TVEVQX0VWRU5UX05BTUUgfSlcbiAgICAgIGF3YWl0IHRoaXMuZXZlbnRCcm9hZGNhc3Rlci5icm9hZGNhc3RBcm91bmRFdmVudChldmVudCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBzdGVwUmVzdWx0ID0gYXdhaXQgdGhpcy5ydW5TdGVwKHN0ZXApXG4gICAgICAgIGF3YWl0IHRoaXMuYnJvYWRjYXN0U3RlcFJlc3VsdChzdGVwUmVzdWx0KVxuICAgICAgfSlcbiAgICB9KVxuICB9XG59XG4iXX0=