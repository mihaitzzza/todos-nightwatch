'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _utilArity = require('util-arity');

var _utilArity2 = _interopRequireDefault(_utilArity);

var _isGenerator = require('is-generator');

var _isGenerator2 = _interopRequireDefault(_isGenerator);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _parameter_type_registry_builder = require('./parameter_type_registry_builder');

var _parameter_type_registry_builder2 = _interopRequireDefault(_parameter_type_registry_builder);

var _helpers = require('./helpers');

var helpers = _interopRequireWildcard(_helpers);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function build(_ref) {
  var cwd = _ref.cwd,
      fns = _ref.fns;

  var options = {
    afterHookDefinitions: [],
    beforeHookDefinitions: [],
    defaultTimeout: 5000,
    listeners: [],
    stepDefinitions: [],
    parameterTypeRegistry: _parameter_type_registry_builder2.default.build(),
    World: function World(_ref2) {
      var attach = _ref2.attach,
          parameters = _ref2.parameters;

      this.attach = attach;
      this.parameters = parameters;
    }
  };
  var definitionFunctionWrapper = null;
  var fnArgument = {
    addTransform: helpers.addTransform(options.parameterTypeRegistry),
    defineParameterType: helpers.defineParameterType(options.parameterTypeRegistry),
    After: helpers.defineHook(cwd, options.afterHookDefinitions),
    Before: helpers.defineHook(cwd, options.beforeHookDefinitions),
    defineStep: helpers.defineStep(cwd, options.stepDefinitions),
    registerHandler: helpers.registerHandler(cwd, options.listeners),
    registerListener: function registerListener(listener) {
      options.listeners.push(listener);
    },
    setDefaultTimeout: function setDefaultTimeout(milliseconds) {
      options.defaultTimeout = milliseconds;
    },
    setDefinitionFunctionWrapper: function setDefinitionFunctionWrapper(fn) {
      definitionFunctionWrapper = fn;
    },
    setWorldConstructor: function setWorldConstructor(fn) {
      options.World = fn;
    }
  };
  fnArgument.Given = fnArgument.When = fnArgument.Then = fnArgument.defineStep;
  fns.forEach(function (fn) {
    return fn(fnArgument);
  });
  wrapDefinitions({
    cwd: cwd,
    definitionFunctionWrapper: definitionFunctionWrapper,
    definitions: _lodash2.default.chain(['afterHook', 'beforeHook', 'step']).map(function (key) {
      return options[key + 'Definitions'];
    }).flatten().value()
  });
  options.afterHookDefinitions.reverse();
  return options;
}

function wrapDefinitions(_ref3) {
  var cwd = _ref3.cwd,
      definitionFunctionWrapper = _ref3.definitionFunctionWrapper,
      definitions = _ref3.definitions;

  if (definitionFunctionWrapper) {
    definitions.forEach(function (definition) {
      var codeLength = definition.code.length;
      var wrappedFn = definitionFunctionWrapper(definition.code, definition.options.wrapperOptions);
      if (wrappedFn !== definition.code) {
        definition.code = (0, _utilArity2.default)(codeLength, wrappedFn);
      }
    });
  } else {
    var generatorDefinitions = _lodash2.default.filter(definitions, function (definition) {
      return _isGenerator2.default.fn(definition.code);
    });
    if (generatorDefinitions.length > 0) {
      var references = generatorDefinitions.map(function (definition) {
        return _path2.default.relative(cwd, definition.uri) + ':' + definition.line;
      }).join('\n  ');
      var message = '\n        The following hook/step definitions use generator functions:\n\n          ' + references + '\n\n        Use \'this.setDefinitionFunctionWrapper(fn)\' to wrap then in a function that returns a promise.\n        ';
      throw new Error(message);
    }
  }
}

exports.default = { build: build };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zdXBwb3J0X2NvZGVfbGlicmFyeS9idWlsZGVyLmpzIl0sIm5hbWVzIjpbImhlbHBlcnMiLCJidWlsZCIsImN3ZCIsImZucyIsIm9wdGlvbnMiLCJhZnRlckhvb2tEZWZpbml0aW9ucyIsImJlZm9yZUhvb2tEZWZpbml0aW9ucyIsImRlZmF1bHRUaW1lb3V0IiwibGlzdGVuZXJzIiwic3RlcERlZmluaXRpb25zIiwicGFyYW1ldGVyVHlwZVJlZ2lzdHJ5IiwiV29ybGQiLCJhdHRhY2giLCJwYXJhbWV0ZXJzIiwiZGVmaW5pdGlvbkZ1bmN0aW9uV3JhcHBlciIsImZuQXJndW1lbnQiLCJhZGRUcmFuc2Zvcm0iLCJkZWZpbmVQYXJhbWV0ZXJUeXBlIiwiQWZ0ZXIiLCJkZWZpbmVIb29rIiwiQmVmb3JlIiwiZGVmaW5lU3RlcCIsInJlZ2lzdGVySGFuZGxlciIsInJlZ2lzdGVyTGlzdGVuZXIiLCJsaXN0ZW5lciIsInB1c2giLCJzZXREZWZhdWx0VGltZW91dCIsIm1pbGxpc2Vjb25kcyIsInNldERlZmluaXRpb25GdW5jdGlvbldyYXBwZXIiLCJmbiIsInNldFdvcmxkQ29uc3RydWN0b3IiLCJHaXZlbiIsIldoZW4iLCJUaGVuIiwiZm9yRWFjaCIsIndyYXBEZWZpbml0aW9ucyIsImRlZmluaXRpb25zIiwiY2hhaW4iLCJtYXAiLCJrZXkiLCJmbGF0dGVuIiwidmFsdWUiLCJyZXZlcnNlIiwiY29kZUxlbmd0aCIsImRlZmluaXRpb24iLCJjb2RlIiwibGVuZ3RoIiwid3JhcHBlZEZuIiwid3JhcHBlck9wdGlvbnMiLCJnZW5lcmF0b3JEZWZpbml0aW9ucyIsImZpbHRlciIsInJlZmVyZW5jZXMiLCJyZWxhdGl2ZSIsInVyaSIsImxpbmUiLCJqb2luIiwibWVzc2FnZSIsIkVycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7O0lBQVlBLE87Ozs7OztBQUNaLFNBQVND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Q0QsbUJBQVdDLElBQVgsR0FBa0IseUJBQU1GLFVBQU4sRUFBa0JJLFNBQWxCLENBQWxCO0FBQ0Q7QUFDRixLQVREO0FBVUQsR0FYRCxNQVdPO0FBQ0wsUUFBTUUsdUJBQXVCLGlCQUFFQyxNQUFGLENBQVNkLFdBQVQsRUFBc0Isc0JBQWM7QUFDL0QsYUFBTyxzQkFBWVAsRUFBWixDQUFlZSxXQUFXQyxJQUExQixDQUFQO0FBQ0QsS0FGNEIsQ0FBN0I7QUFHQSxRQUFJSSxxQkFBcUJILE1BQXJCLEdBQThCLENBQWxDLEVBQXFDO0FBQ25DLFVBQU1LLGFBQWFGLHFCQUNoQlgsR0FEZ0IsQ0FDWixzQkFBYztBQUNqQixlQUFPLGVBQUtjLFFBQUwsQ0FBY2xELEdBQWQsRUFBbUIwQyxXQUFXUyxHQUE5QixJQUFxQyxHQUFyQyxHQUEyQ1QsV0FBV1UsSUFBN0Q7QUFDRCxPQUhnQixFQUloQkMsSUFKZ0IsQ0FJWCxNQUpXLENBQW5CO0FBS0EsVUFBTUMsbUdBR0FMLFVBSEEsMkhBQU47QUFPQSxZQUFNLElBQUlNLEtBQUosQ0FBVUQsT0FBVixDQUFOO0FBQ0Q7QUFDRjtBQUNGOztrQkFFYyxFQUFFdkQsWUFBRixFIiwiZmlsZSI6ImJ1aWxkZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnXG5pbXBvcnQgYXJpdHkgZnJvbSAndXRpbC1hcml0eSdcbmltcG9ydCBpc0dlbmVyYXRvciBmcm9tICdpcy1nZW5lcmF0b3InXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IFRyYW5zZm9ybUxvb2t1cEJ1aWxkZXIgZnJvbSAnLi9wYXJhbWV0ZXJfdHlwZV9yZWdpc3RyeV9idWlsZGVyJ1xuaW1wb3J0ICogYXMgaGVscGVycyBmcm9tICcuL2hlbHBlcnMnXG5mdW5jdGlvbiBidWlsZCh7IGN3ZCwgZm5zIH0pIHtcbiAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICBhZnRlckhvb2tEZWZpbml0aW9uczogW10sXG4gICAgYmVmb3JlSG9va0RlZmluaXRpb25zOiBbXSxcbiAgICBkZWZhdWx0VGltZW91dDogNTAwMCxcbiAgICBsaXN0ZW5lcnM6IFtdLFxuICAgIHN0ZXBEZWZpbml0aW9uczogW10sXG4gICAgcGFyYW1ldGVyVHlwZVJlZ2lzdHJ5OiBUcmFuc2Zvcm1Mb29rdXBCdWlsZGVyLmJ1aWxkKCksXG4gICAgV29ybGQoeyBhdHRhY2gsIHBhcmFtZXRlcnMgfSkge1xuICAgICAgdGhpcy5hdHRhY2ggPSBhdHRhY2hcbiAgICAgIHRoaXMucGFyYW1ldGVycyA9IHBhcmFtZXRlcnNcbiAgICB9XG4gIH1cbiAgbGV0IGRlZmluaXRpb25GdW5jdGlvbldyYXBwZXIgPSBudWxsXG4gIGNvbnN0IGZuQXJndW1lbnQgPSB7XG4gICAgYWRkVHJhbnNmb3JtOiBoZWxwZXJzLmFkZFRyYW5zZm9ybShvcHRpb25zLnBhcmFtZXRlclR5cGVSZWdpc3RyeSksXG4gICAgZGVmaW5lUGFyYW1ldGVyVHlwZTogaGVscGVycy5kZWZpbmVQYXJhbWV0ZXJUeXBlKFxuICAgICAgb3B0aW9ucy5wYXJhbWV0ZXJUeXBlUmVnaXN0cnlcbiAgICApLFxuICAgIEFmdGVyOiBoZWxwZXJzLmRlZmluZUhvb2soY3dkLCBvcHRpb25zLmFmdGVySG9va0RlZmluaXRpb25zKSxcbiAgICBCZWZvcmU6IGhlbHBlcnMuZGVmaW5lSG9vayhjd2QsIG9wdGlvbnMuYmVmb3JlSG9va0RlZmluaXRpb25zKSxcbiAgICBkZWZpbmVTdGVwOiBoZWxwZXJzLmRlZmluZVN0ZXAoY3dkLCBvcHRpb25zLnN0ZXBEZWZpbml0aW9ucyksXG4gICAgcmVnaXN0ZXJIYW5kbGVyOiBoZWxwZXJzLnJlZ2lzdGVySGFuZGxlcihjd2QsIG9wdGlvbnMubGlzdGVuZXJzKSxcbiAgICByZWdpc3Rlckxpc3RlbmVyKGxpc3RlbmVyKSB7XG4gICAgICBvcHRpb25zLmxpc3RlbmVycy5wdXNoKGxpc3RlbmVyKVxuICAgIH0sXG4gICAgc2V0RGVmYXVsdFRpbWVvdXQobWlsbGlzZWNvbmRzKSB7XG4gICAgICBvcHRpb25zLmRlZmF1bHRUaW1lb3V0ID0gbWlsbGlzZWNvbmRzXG4gICAgfSxcbiAgICBzZXREZWZpbml0aW9uRnVuY3Rpb25XcmFwcGVyKGZuKSB7XG4gICAgICBkZWZpbml0aW9uRnVuY3Rpb25XcmFwcGVyID0gZm5cbiAgICB9LFxuICAgIHNldFdvcmxkQ29uc3RydWN0b3IoZm4pIHtcbiAgICAgIG9wdGlvbnMuV29ybGQgPSBmblxuICAgIH1cbiAgfVxuICBmbkFyZ3VtZW50LkdpdmVuID0gZm5Bcmd1bWVudC5XaGVuID0gZm5Bcmd1bWVudC5UaGVuID0gZm5Bcmd1bWVudC5kZWZpbmVTdGVwXG4gIGZucy5mb3JFYWNoKGZuID0+IGZuKGZuQXJndW1lbnQpKVxuICB3cmFwRGVmaW5pdGlvbnMoe1xuICAgIGN3ZCxcbiAgICBkZWZpbml0aW9uRnVuY3Rpb25XcmFwcGVyLFxuICAgIGRlZmluaXRpb25zOiBfLmNoYWluKFsnYWZ0ZXJIb29rJywgJ2JlZm9yZUhvb2snLCAnc3RlcCddKVxuICAgICAgLm1hcChrZXkgPT4gb3B0aW9uc1trZXkgKyAnRGVmaW5pdGlvbnMnXSlcbiAgICAgIC5mbGF0dGVuKClcbiAgICAgIC52YWx1ZSgpXG4gIH0pXG4gIG9wdGlvbnMuYWZ0ZXJIb29rRGVmaW5pdGlvbnMucmV2ZXJzZSgpXG4gIHJldHVybiBvcHRpb25zXG59XG5cbmZ1bmN0aW9uIHdyYXBEZWZpbml0aW9ucyh7IGN3ZCwgZGVmaW5pdGlvbkZ1bmN0aW9uV3JhcHBlciwgZGVmaW5pdGlvbnMgfSkge1xuICBpZiAoZGVmaW5pdGlvbkZ1bmN0aW9uV3JhcHBlcikge1xuICAgIGRlZmluaXRpb25zLmZvckVhY2goZGVmaW5pdGlvbiA9PiB7XG4gICAgICBjb25zdCBjb2RlTGVuZ3RoID0gZGVmaW5pdGlvbi5jb2RlLmxlbmd0aFxuICAgICAgY29uc3Qgd3JhcHBlZEZuID0gZGVmaW5pdGlvbkZ1bmN0aW9uV3JhcHBlcihcbiAgICAgICAgZGVmaW5pdGlvbi5jb2RlLFxuICAgICAgICBkZWZpbml0aW9uLm9wdGlvbnMud3JhcHBlck9wdGlvbnNcbiAgICAgIClcbiAgICAgIGlmICh3cmFwcGVkRm4gIT09IGRlZmluaXRpb24uY29kZSkge1xuICAgICAgICBkZWZpbml0aW9uLmNvZGUgPSBhcml0eShjb2RlTGVuZ3RoLCB3cmFwcGVkRm4pXG4gICAgICB9XG4gICAgfSlcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBnZW5lcmF0b3JEZWZpbml0aW9ucyA9IF8uZmlsdGVyKGRlZmluaXRpb25zLCBkZWZpbml0aW9uID0+IHtcbiAgICAgIHJldHVybiBpc0dlbmVyYXRvci5mbihkZWZpbml0aW9uLmNvZGUpXG4gICAgfSlcbiAgICBpZiAoZ2VuZXJhdG9yRGVmaW5pdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgcmVmZXJlbmNlcyA9IGdlbmVyYXRvckRlZmluaXRpb25zXG4gICAgICAgIC5tYXAoZGVmaW5pdGlvbiA9PiB7XG4gICAgICAgICAgcmV0dXJuIHBhdGgucmVsYXRpdmUoY3dkLCBkZWZpbml0aW9uLnVyaSkgKyAnOicgKyBkZWZpbml0aW9uLmxpbmVcbiAgICAgICAgfSlcbiAgICAgICAgLmpvaW4oJ1xcbiAgJylcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSBgXG4gICAgICAgIFRoZSBmb2xsb3dpbmcgaG9vay9zdGVwIGRlZmluaXRpb25zIHVzZSBnZW5lcmF0b3IgZnVuY3Rpb25zOlxuXG4gICAgICAgICAgJHtyZWZlcmVuY2VzfVxuXG4gICAgICAgIFVzZSAndGhpcy5zZXREZWZpbml0aW9uRnVuY3Rpb25XcmFwcGVyKGZuKScgdG8gd3JhcCB0aGVuIGluIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGEgcHJvbWlzZS5cbiAgICAgICAgYFxuICAgICAgdGhyb3cgbmV3IEVycm9yKG1lc3NhZ2UpXG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IHsgYnVpbGQgfVxuIl19